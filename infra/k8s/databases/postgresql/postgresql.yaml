# =============================================================================
# PostgreSQL - Primary + Replica (Streaming Replication)
# Database: stocksimulator
# Schemas: users, stocks, trading, events, scheduler, season
# =============================================================================
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-config
  namespace: stocksim-db
  labels:
    app: postgresql
data:
  # Primary 설정
  postgresql.conf: |
    listen_addresses = '*'
    port = 5432
    max_connections = 200
    shared_buffers = 256MB
    work_mem = 16MB
    maintenance_work_mem = 128MB
    effective_cache_size = 768MB
    
    # WAL 설정 (Replication용)
    wal_level = replica
    max_wal_senders = 10
    max_replication_slots = 10
    wal_keep_size = 1GB
    hot_standby = on
    hot_standby_feedback = on
    
    # Logging
    log_destination = 'stderr'
    logging_collector = off
    log_statement = 'ddl'
    log_min_duration_statement = 1000
    
    # Performance
    synchronous_commit = on
    checkpoint_completion_target = 0.9
    random_page_cost = 1.1

  pg_hba.conf: |
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    local   all             all                                     trust
    host    all             all             127.0.0.1/32            scram-sha-256
    host    all             all             0.0.0.0/0               scram-sha-256
    host    replication     replicator      0.0.0.0/0               scram-sha-256

  # 초기화 스크립트 - 스키마 및 사용자 생성
  init-db.sql: |
    -- 스키마 생성
    CREATE SCHEMA IF NOT EXISTS users;
    CREATE SCHEMA IF NOT EXISTS stocks;
    CREATE SCHEMA IF NOT EXISTS trading;
    CREATE SCHEMA IF NOT EXISTS events;
    CREATE SCHEMA IF NOT EXISTS scheduler;
    CREATE SCHEMA IF NOT EXISTS season;
    
    -- 읽기 전용 사용자 생성
    CREATE USER stocksim_readonly WITH PASSWORD 'stocksim123';
    GRANT CONNECT ON DATABASE stocksimulator TO stocksim_readonly;
    GRANT USAGE ON SCHEMA users, stocks, trading, events, scheduler, season TO stocksim_readonly;
    ALTER DEFAULT PRIVILEGES IN SCHEMA users GRANT SELECT ON TABLES TO stocksim_readonly;
    ALTER DEFAULT PRIVILEGES IN SCHEMA stocks GRANT SELECT ON TABLES TO stocksim_readonly;
    ALTER DEFAULT PRIVILEGES IN SCHEMA trading GRANT SELECT ON TABLES TO stocksim_readonly;
    ALTER DEFAULT PRIVILEGES IN SCHEMA events GRANT SELECT ON TABLES TO stocksim_readonly;
    ALTER DEFAULT PRIVILEGES IN SCHEMA scheduler GRANT SELECT ON TABLES TO stocksim_readonly;
    ALTER DEFAULT PRIVILEGES IN SCHEMA season GRANT SELECT ON TABLES TO stocksim_readonly;
    
    -- Replication 사용자 생성
    CREATE USER replicator WITH REPLICATION ENCRYPTED PASSWORD 'repl123';
    
    -- 메인 사용자에게 스키마 권한 부여
    GRANT ALL PRIVILEGES ON SCHEMA users, stocks, trading, events, scheduler, season TO stocksim;
    ALTER DEFAULT PRIVILEGES IN SCHEMA users GRANT ALL ON TABLES TO stocksim;
    ALTER DEFAULT PRIVILEGES IN SCHEMA stocks GRANT ALL ON TABLES TO stocksim;
    ALTER DEFAULT PRIVILEGES IN SCHEMA trading GRANT ALL ON TABLES TO stocksim;
    ALTER DEFAULT PRIVILEGES IN SCHEMA events GRANT ALL ON TABLES TO stocksim;
    ALTER DEFAULT PRIVILEGES IN SCHEMA scheduler GRANT ALL ON TABLES TO stocksim;
    ALTER DEFAULT PRIVILEGES IN SCHEMA season GRANT ALL ON TABLES TO stocksim;

---
apiVersion: v1
kind: Secret
metadata:
  name: postgresql-credentials
  namespace: stocksim-db
  labels:
    app: postgresql
type: Opaque
stringData:
  postgres-password: "postgres123"
  username: "stocksim"
  password: "stocksim123"
  readonly-username: "stocksim_readonly"
  readonly-password: "stocksim123"
  replicator-password: "repl123"

---
# =============================================================================
# PostgreSQL Primary (Write)
# =============================================================================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgresql-primary
  namespace: stocksim-db
  labels:
    app: postgresql
    role: primary
spec:
  serviceName: postgresql-primary
  replicas: 1
  selector:
    matchLabels:
      app: postgresql
      role: primary
  template:
    metadata:
      labels:
        app: postgresql
        role: primary
    spec:
      containers:
        - name: postgresql
          image: postgres:16-alpine
          ports:
            - containerPort: 5432
              name: postgresql
          env:
            - name: POSTGRES_DB
              value: stocksimulator
            - name: POSTGRES_USER
              value: stocksim
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-credentials
                  key: password
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
            - name: config
              mountPath: /etc/postgresql/postgresql.conf
              subPath: postgresql.conf
            - name: config
              mountPath: /etc/postgresql/pg_hba.conf
              subPath: pg_hba.conf
            - name: init-scripts
              mountPath: /docker-entrypoint-initdb.d
          args:
            - -c
            - config_file=/etc/postgresql/postgresql.conf
            - -c
            - hba_file=/etc/postgresql/pg_hba.conf
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          startupProbe:
            exec:
              command: ["pg_isready", "-U", "stocksim", "-d", "stocksimulator"]
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 30
          readinessProbe:
            exec:
              command: ["pg_isready", "-U", "stocksim", "-d", "stocksimulator"]
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3
          livenessProbe:
            exec:
              command: ["pg_isready", "-U", "stocksim", "-d", "stocksimulator"]
            initialDelaySeconds: 10
            periodSeconds: 30
            failureThreshold: 3
      volumes:
        - name: config
          configMap:
            name: postgresql-config
        - name: init-scripts
          configMap:
            name: postgresql-config
            items:
              - key: init-db.sql
                path: init-db.sql
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: local-path
        resources:
          requests:
            storage: 10Gi

---
apiVersion: v1
kind: Service
metadata:
  name: postgresql-primary
  namespace: stocksim-db
  labels:
    app: postgresql
    role: primary
spec:
  ports:
    - port: 5432
      targetPort: 5432
      name: postgresql
  selector:
    app: postgresql
    role: primary
  clusterIP: None

---
# Write용 Service (Primary 전용)
apiVersion: v1
kind: Service
metadata:
  name: postgresql-write
  namespace: stocksim-db
  labels:
    app: postgresql
    role: write
spec:
  ports:
    - port: 5432
      targetPort: 5432
      name: postgresql
  selector:
    app: postgresql
    role: primary

---
# =============================================================================
# PostgreSQL Replica (Read)
# =============================================================================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgresql-replica
  namespace: stocksim-db
  labels:
    app: postgresql
    role: replica
spec:
  serviceName: postgresql-replica
  replicas: 1
  selector:
    matchLabels:
      app: postgresql
      role: replica
  template:
    metadata:
      labels:
        app: postgresql
        role: replica
    spec:
      initContainers:
        # Primary가 준비될 때까지 대기
        - name: wait-for-primary
          image: postgres:16-alpine
          command:
            - sh
            - -c
            - |
              until pg_isready -h postgresql-primary.stocksim-db.svc.cluster.local -p 5432 -U stocksim; do
                echo "Waiting for primary..."
                sleep 5
              done
              echo "Primary is ready!"
        # Primary에서 데이터 복제
        - name: init-replica
          image: postgres:16-alpine
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-credentials
                  key: replicator-password
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
          command:
            - sh
            - -c
            - |
              if [ -s "$PGDATA/PG_VERSION" ]; then
                echo "Data directory already initialized, skipping pg_basebackup"
              else
                echo "Running pg_basebackup..."
                pg_basebackup -h postgresql-primary.stocksim-db.svc.cluster.local \
                  -D "$PGDATA" -U replicator -Fp -Xs -P -R
              fi
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
      containers:
        - name: postgresql
          image: postgres:16-alpine
          ports:
            - containerPort: 5432
              name: postgresql
          env:
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
            - name: config
              mountPath: /etc/postgresql/postgresql.conf
              subPath: postgresql.conf
            - name: config
              mountPath: /etc/postgresql/pg_hba.conf
              subPath: pg_hba.conf
          args:
            - -c
            - config_file=/etc/postgresql/postgresql.conf
            - -c
            - hba_file=/etc/postgresql/pg_hba.conf
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          startupProbe:
            exec:
              command: ["pg_isready", "-U", "stocksim", "-d", "stocksimulator"]
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 30
          readinessProbe:
            exec:
              command: ["pg_isready", "-U", "stocksim", "-d", "stocksimulator"]
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3
          livenessProbe:
            exec:
              command: ["pg_isready", "-U", "stocksim", "-d", "stocksimulator"]
            initialDelaySeconds: 10
            periodSeconds: 30
            failureThreshold: 3
      volumes:
        - name: config
          configMap:
            name: postgresql-config
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: local-path
        resources:
          requests:
            storage: 10Gi

---
apiVersion: v1
kind: Service
metadata:
  name: postgresql-replica
  namespace: stocksim-db
  labels:
    app: postgresql
    role: replica
spec:
  ports:
    - port: 5432
      targetPort: 5432
      name: postgresql
  selector:
    app: postgresql
    role: replica
  clusterIP: None

---
# Read용 Service (Replica들에 로드밸런싱)
apiVersion: v1
kind: Service
metadata:
  name: postgresql-read
  namespace: stocksim-db
  labels:
    app: postgresql
    role: read
spec:
  ports:
    - port: 5432
      targetPort: 5432
      name: postgresql
  selector:
    app: postgresql
    role: replica
