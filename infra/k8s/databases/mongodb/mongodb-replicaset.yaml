# =============================================================================
# MongoDB ReplicaSet for News/Event Service
# 3-node ReplicaSet 구성
# =============================================================================
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-config
  namespace: stocksim-db
data:
  mongod.conf: |
    storage:
      dbPath: /data/db
      journal:
        enabled: true
    net:
      port: 27017
      bindIp: 0.0.0.0
    replication:
      replSetName: rs0
    security:
      authorization: enabled
      keyFile: /etc/mongodb/keyfile
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-init-scripts
  namespace: stocksim-db
data:
  init-replica.sh: |
    #!/bin/bash
    sleep 10
    
    # Primary에서만 실행
    if [ "$HOSTNAME" == "mongodb-0" ]; then
      mongosh --eval "
        rs.initiate({
          _id: 'rs0',
          members: [
            { _id: 0, host: 'mongodb-0.mongodb.stocksim-db.svc.cluster.local:27017', priority: 2 },
            { _id: 1, host: 'mongodb-1.mongodb.stocksim-db.svc.cluster.local:27017', priority: 1 },
            { _id: 2, host: 'mongodb-2.mongodb.stocksim-db.svc.cluster.local:27017', priority: 1 }
          ]
        });
      "
      
      sleep 10
      
      # Admin 사용자 생성
      mongosh admin --eval "
        db.createUser({
          user: 'stocksim',
          pwd: 'stocksim123',
          roles: [
            { role: 'root', db: 'admin' },
            { role: 'readWrite', db: 'newsdb' },
            { role: 'readWrite', db: 'eventdb' }
          ]
        });
      "
    fi
---
apiVersion: v1
kind: Secret
metadata:
  name: mongodb-keyfile
  namespace: stocksim-db
type: Opaque
stringData:
  keyfile: |
    stocksimReplicaSetKey123456789abcdefghijklmnopqrstuvwxyz
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
  namespace: stocksim-db
  labels:
    app: mongodb
spec:
  serviceName: mongodb
  replicas: 3
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      initContainers:
        - name: init-keyfile
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              cp /etc/mongodb-keyfile/keyfile /etc/mongodb/keyfile
              chmod 400 /etc/mongodb/keyfile
              chown 999:999 /etc/mongodb/keyfile
          volumeMounts:
            - name: keyfile-secret
              mountPath: /etc/mongodb-keyfile
            - name: keyfile
              mountPath: /etc/mongodb
      containers:
        - name: mongodb
          image: mongo:7.0
          ports:
            - containerPort: 27017
              name: mongodb
          env:
            - name: MONGO_INITDB_ROOT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: root-username
            - name: MONGO_INITDB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: root-password
          args:
            - --config
            - /etc/mongod.conf
          volumeMounts:
            - name: data
              mountPath: /data/db
            - name: config
              mountPath: /etc/mongod.conf
              subPath: mongod.conf
            - name: keyfile
              mountPath: /etc/mongodb
            - name: init-scripts
              mountPath: /docker-entrypoint-initdb.d
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "500m"
          readinessProbe:
            exec:
              command:
                - mongosh
                - --eval
                - "db.adminCommand('ping')"
            initialDelaySeconds: 30
            periodSeconds: 10
          livenessProbe:
            exec:
              command:
                - mongosh
                - --eval
                - "db.adminCommand('ping')"
            initialDelaySeconds: 60
            periodSeconds: 20
      volumes:
        - name: config
          configMap:
            name: mongodb-config
        - name: init-scripts
          configMap:
            name: mongodb-init-scripts
            defaultMode: 0755
        - name: keyfile-secret
          secret:
            secretName: mongodb-keyfile
        - name: keyfile
          emptyDir: {}
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: local-path
        resources:
          requests:
            storage: 10Gi
---
# Headless Service for StatefulSet
apiVersion: v1
kind: Service
metadata:
  name: mongodb
  namespace: stocksim-db
  labels:
    app: mongodb
spec:
  ports:
    - port: 27017
      targetPort: 27017
      name: mongodb
  clusterIP: None
  selector:
    app: mongodb
---
# Read용 Service (Secondary에 로드밸런싱)
apiVersion: v1
kind: Service
metadata:
  name: mongodb-read
  namespace: stocksim-db
  labels:
    app: mongodb
spec:
  ports:
    - port: 27017
      targetPort: 27017
      name: mongodb
  selector:
    app: mongodb
