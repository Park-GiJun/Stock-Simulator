# =============================================================================
# MySQL ConfigMaps - Master 및 Replica 설정
# =============================================================================
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-master-config
  namespace: stocksim-db
data:
  my.cnf: |
    [mysqld]
    # Replication - Master
    server-id=1
    log-bin=mysql-bin
    binlog-format=ROW
    binlog-row-image=FULL
    expire-logs-days=7
    max-binlog-size=100M
    
    # GTID 기반 Replication
    gtid-mode=ON
    enforce-gtid-consistency=ON
    log-slave-updates=ON
    
    # Character Set
    character-set-server=utf8mb4
    collation-server=utf8mb4_unicode_ci
    
    # InnoDB 설정
    innodb-buffer-pool-size=256M
    innodb-log-file-size=64M
    innodb-flush-log-at-trx-commit=1
    sync-binlog=1
    
    # Connection
    max-connections=200
    wait-timeout=28800
    
    [mysql]
    default-character-set=utf8mb4
    
    [client]
    default-character-set=utf8mb4
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-replica-config
  namespace: stocksim-db
data:
  my.cnf: |
    [mysqld]
    # Replication - Replica (Read-Only)
    server-id=2
    read-only=ON
    super-read-only=ON
    
    # GTID 기반 Replication
    gtid-mode=ON
    enforce-gtid-consistency=ON
    log-slave-updates=ON
    relay-log=relay-bin
    relay-log-purge=ON
    
    # Binary log (Cascading용)
    log-bin=mysql-bin
    binlog-format=ROW
    
    # Character Set
    character-set-server=utf8mb4
    collation-server=utf8mb4_unicode_ci
    
    # InnoDB 설정
    innodb-buffer-pool-size=256M
    innodb-log-file-size=64M
    
    # Connection
    max-connections=200
    wait-timeout=28800
    
    [mysql]
    default-character-set=utf8mb4
    
    [client]
    default-character-set=utf8mb4
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-init-scripts
  namespace: stocksim-db
data:
  01-create-users.sql: |
    -- Replication User
    CREATE USER IF NOT EXISTS 'replicator'@'%' IDENTIFIED BY 'repl123';
    GRANT REPLICATION SLAVE ON *.* TO 'replicator'@'%';
    
    -- Read-Only User for Replicas
    CREATE USER IF NOT EXISTS 'stocksim_readonly'@'%' IDENTIFIED BY 'stocksim123';
    GRANT SELECT ON *.* TO 'stocksim_readonly'@'%';
    
    FLUSH PRIVILEGES;
  
  02-setup-replication.sh: |
    #!/bin/bash
    # Replica 초기화 시 실행되는 스크립트
    # Master 호스트명은 환경변수로 전달됨
    
    if [ -n "$MYSQL_MASTER_HOST" ]; then
      mysql -u root -p"$MYSQL_ROOT_PASSWORD" <<EOF
    CHANGE MASTER TO
      MASTER_HOST='$MYSQL_MASTER_HOST',
      MASTER_USER='replicator',
      MASTER_PASSWORD='repl123',
      MASTER_AUTO_POSITION=1;
    START SLAVE;
    EOF
    fi
