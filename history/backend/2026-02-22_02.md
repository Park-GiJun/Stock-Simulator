# 2026-02-22_02: NPC/기관투자자 자동매매 스케줄링 시스템 구현

## 변경 사항

### 1. Common 모듈 - 새 이벤트 정의
- `KafkaTopics`에 `TRIGGER_NPC_TRADING`, `TRIGGER_INSTITUTION_TRADING` 토픽 상수 추가
- `NpcTradingTriggerEvent`, `InstitutionTradingTriggerEvent` 이벤트 클래스 추가 (tradingFrequency, maxBatchSize 파라미터)

### 2. Stock-Service - 빈도별 투자자 조회 API
- `NpcJpaRepository` / `InstitutionJpaRepository`: `findByTradingFrequency()` 메서드 추가
- `NpcPersistencePort` / `InstitutionPersistencePort`: `findByTradingFrequency()` 인터페이스 추가
- `NpcPersistenceAdapter` / `InstitutionPersistenceAdapter`: 구현 추가
- `GetNpcsByFrequencyUseCase` / `GetInstitutionsByFrequencyUseCase`: 새 유스케이스 인터페이스
- `NpcCommandHandler` / `InstitutionCommandHandler`: 빈도별 조회 메서드 구현
- `InvestorWebAdapter`: 2개 엔드포인트 추가
  - `GET /api/investors/npcs/by-frequency?frequency=HIGH&maxCount=5`
  - `GET /api/investors/institutions/by-frequency?frequency=HIGH&maxCount=3`

### 3. Scheduler-Service - 자동매매 트리거 스케줄러
- `TriggerPublishPort`: `publishNpcTradingTrigger()`, `publishInstitutionTradingTrigger()` 추가
- `KafkaTriggerPublisher`: 위 2개 메서드 구현
- `NpcTradingScheduler`: HIGH(5분)/MEDIUM(15분)/LOW(30분) 주기 트리거 (배치 최대 5명)
- `InstitutionTradingScheduler`: HIGH(5분)/MEDIUM(15분)/LOW(30분) 주기 트리거 (배치 최대 3곳)

### 4. Event-Service - 포트 정의
- `InvestorProfileQueryPort`: NPC/기관 프로필 조회
- `InvestorPortfolioQueryPort`: 잔고/보유종목 조회
- `StockCandidateQueryPort`: 후보 종목 조회
- `TradingDecisionGeneratePort`: LLM 매매 결정 인터페이스 + DTO
- `TradeEventPublishPort`: schedule.trade Kafka 발행

### 5. Event-Service - 어댑터 구현
- `TradingServiceFeignClient`: trading-service 잔고/포트폴리오 Feign 클라이언트
- `StockServiceFeignClient`: getNpcsByFrequency/getInstitutionsByFrequency/getStocks 메서드 추가
- `InvestorProfileQueryAdapter`: stock-service Feign 호출로 프로필 조회
- `InvestorPortfolioQueryAdapter`: trading-service Feign 호출로 포트폴리오 조회
- `StockCandidateQueryAdapter`: stock-service Feign 호출로 후보 종목 조회
- `KafkaTradeEventPublisher`: schedule.trade 토픽 Kafka 발행
- `TradingClientDtos.kt`: Feign 응답 DTO 모음

### 6. Event-Service - LLM 매매 결정 생성기
- `TradingDecisionGeneratorWithLLM`: Koog AIAgent + Haiku 4.5 활용
  - 투자자 프로필/보유종목/후보종목/뉴스 기반 한국어 프롬프트
  - 3회 재시도, 실패 시 HOLD 반환 (서비스 중단 방지)
  - 투자성향별 최대 투자비율: AGGRESSIVE 30%, STABLE 10%, VALUE 20%, RANDOM 15%

### 7. Event-Service - 비즈니스 핸들러
- `NpcTradingHandler`: NPC 자동매매 로직 (프로필→포트폴리오→후보종목→뉴스→LLM→주문)
- `InstitutionTradingHandler`: 기관투자자 자동매매 로직 (동일 패턴)
- investorId 형식: NPC_{npcId} / INST_{institutionId}

### 8. Event-Service - Kafka Consumer
- `NpcTradingTriggerConsumer`: trigger.npc.trading 토픽 수신 → NpcTradingHandler 호출
- `InstitutionTradingTriggerConsumer`: trigger.institution.trading 토픽 수신 → InstitutionTradingHandler 호출

## 데이터 흐름
```
scheduler-service (@Scheduled)
  → Kafka: trigger.npc.trading / trigger.institution.trading
    → event-service (Consumer)
      1. Feign → stock-service: 빈도별 NPC/기관 목록
      2. Feign → trading-service: 잔고/포트폴리오
      3. Feign → stock-service: 후보 종목
      4. 내부: 최근 뉴스 조회
      5. LLM → Haiku 4.5: 매매 결정 (BUY/SELL/HOLD)
      6. Kafka → schedule.trade (기존 토픽)
        → trading-service: 주문 실행 (기존 TradingEventConsumer)
```

## 수정 파일 목록
| 파일 | 변경 |
|------|------|
| `backend/common/.../event/DomainEvent.kt` | 2개 토픽 상수 + 2개 이벤트 클래스 추가 |
| `backend/scheduler-service/.../port/out/TriggerPublishPort.kt` | 2개 메서드 추가 |
| `backend/scheduler-service/.../event/KafkaTriggerPublisher.kt` | 2개 구현 추가 |
| `backend/stock-service/.../NpcJpaRepository.kt` | findByTradingFrequency 추가 |
| `backend/stock-service/.../InstitutionJpaRepository.kt` | findByTradingFrequency 추가 |
| `backend/stock-service/.../NpcPersistencePort.kt` | findByTradingFrequency 추가 |
| `backend/stock-service/.../InstitutionPersistencePort.kt` | findByTradingFrequency 추가 |
| `backend/stock-service/.../NpcPersistenceAdapter.kt` | 구현 추가 |
| `backend/stock-service/.../InstitutionPersistenceAdapter.kt` | 구현 추가 |
| `backend/stock-service/.../NpcCommandHandler.kt` | GetNpcsByFrequencyUseCase 구현 추가 |
| `backend/stock-service/.../InstitutionCommandHandler.kt` | GetInstitutionsByFrequencyUseCase 구현 추가 |
| `backend/stock-service/.../InvestorWebAdapter.kt` | 2개 엔드포인트 추가 |
| `backend/event-service/.../StockServiceFeignClient.kt` | 3개 메서드 추가 |

## 새 파일 목록 (~20개)
| 서비스 | 파일 | 역할 |
|--------|------|------|
| scheduler | NpcTradingScheduler.kt | HIGH/MEDIUM/LOW 주기 트리거 |
| scheduler | InstitutionTradingScheduler.kt | HIGH/MEDIUM/LOW 주기 트리거 |
| stock | GetNpcsByFrequencyUseCase.kt | 유스케이스 인터페이스 |
| stock | GetInstitutionsByFrequencyUseCase.kt | 유스케이스 인터페이스 |
| event | InvestorProfileQueryPort.kt | NPC/기관 프로필 조회 포트 + DTO |
| event | InvestorPortfolioQueryPort.kt | 잔고/보유종목 조회 포트 + DTO |
| event | StockCandidateQueryPort.kt | 후보 종목 조회 포트 + DTO |
| event | TradingDecisionGeneratePort.kt | LLM 결정 포트 + DTO |
| event | TradeEventPublishPort.kt | schedule.trade 발행 포트 |
| event | TradingServiceFeignClient.kt | trading-service Feign |
| event | TradingClientDtos.kt | Feign 응답 DTO 모음 |
| event | InvestorProfileQueryAdapter.kt | 프로필 조회 어댑터 |
| event | InvestorPortfolioQueryAdapter.kt | 포트폴리오 조회 어댑터 |
| event | StockCandidateQueryAdapter.kt | 후보 종목 어댑터 |
| event | KafkaTradeEventPublisher.kt | Kafka 발행 어댑터 |
| event | TradingDecisionGeneratorWithLLM.kt | LLM 매매 결정 생성기 |
| event | NpcTradingHandler.kt | NPC 매매 비즈니스 로직 |
| event | InstitutionTradingHandler.kt | 기관 매매 비즈니스 로직 |
| event | NpcTradingTriggerConsumer.kt | Kafka Consumer |
| event | InstitutionTradingTriggerConsumer.kt | Kafka Consumer |

## 배포 시 필요 작업
- Kafka 토픽 자동 생성 또는 수동 생성: `trigger.npc.trading`, `trigger.institution.trading`
- event-service에서 trading-service Feign 호출을 위해 해당 API 엔드포인트가 존재하는지 확인 필요
  - `GET /api/trading/portfolio/{investorId}?investorType=NPC`
  - `GET /api/trading/portfolio/{investorId}/balance?investorType=NPC`
