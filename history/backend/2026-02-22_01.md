# 2026-02-22_01: 백엔드 런타임 에러 수정 + 뉴스 필터링/실제 종목명 + Fallback 제거

## 변경 사항

### 1. event-service: FeignClient 빈 생성 실패 수정
- `EventServiceApplication.kt`에 `@EnableFeignClients` 어노테이션 추가
- `StockServiceFeignClient` 빈 정상 생성

### 2. trading-service: Flyway 마이그레이션 스키마 불일치 수정
- `V3__create_portfolio_tables.sql`: `balance` → `cash` (엔티티 `InvestorBalanceJpaEntity`와 일치)
- `V4__create_trades_table.sql`: 전면 수정
  - `buy_user_id/sell_user_id` → `buyer_id/seller_id`
  - `buyer_type`, `seller_type`, `trade_amount` 컬럼 추가
  - `matched_at` → `traded_at`
  - 인덱스 엔티티 매칭

### 3. 뉴스 level/sentiment 필터링 구현
- `NewsJpaRepository`: `JpaSpecificationExecutor` 추가
- `NewsPersistencePort`: `findByFilters()` 메서드 추가
- `NewsPersistenceAdapter`: JPA Criteria API로 동적 필터 구현
- `NewsQueryHandler`: 기존 `when` 블록 → `findByFilters()` 호출로 통합
- 호재/악재/중립 필터 정상 동작

### 4. COMPANY 레벨 뉴스에 실제 종목명 사용
- `NewsContentGeneratePort`: `stockName` 파라미터 추가
- `NewsContentGeneratorWithLLM`: LLM 프롬프트에 `대상 기업: {stockName}` 포함
- `GameNewsGenerationHandler`: `StockQueryPort` 주입, COMPANY 레벨 시 랜덤 상장 종목 조회

### 5. NPC/기관 생성 주기 변경
- `NpcCreationScheduler`: 10분 → 24시간 (86,400,000ms)
- `InstitutionCreationScheduler`: 2시간 → 24시간 (86,400,000ms)

### 6. 모든 LLM 생성기 Fallback 제거, 3회 Retry 후 종료
- `NewsContentGeneratorWithLLM`: `generateFallback()` 삭제 → 3회 retry 후 RuntimeException
- `NpcNameGeneratorWithLLM`: `generateFallbackName()` 삭제 → 3회 retry 후 RuntimeException
- `InstitutionNameGeneratorWithLLM`: `generateFallbackName()` 삭제 → 3회 retry 후 RuntimeException
- `CompanyNameGeneratorWithLLM`: fallback suffix 로직 삭제 → 3회 retry 후 RuntimeException
- `InstitutionCreationHandler`: `generateUniqueName()` fallback 제거

## 수정 파일 목록

| 파일 | 변경 |
|------|------|
| `backend/event-service/.../EventServiceApplication.kt` | `@EnableFeignClients` 추가 |
| `backend/trading-service/.../V3__create_portfolio_tables.sql` | `balance` → `cash` |
| `backend/trading-service/.../V4__create_trades_table.sql` | 엔티티 일치하도록 전면 수정 |
| `backend/event-service/.../repository/NewsJpaRepository.kt` | `JpaSpecificationExecutor` 추가 |
| `backend/event-service/.../port/out/NewsPersistencePort.kt` | `findByFilters()` 추가 |
| `backend/event-service/.../adapter/NewsPersistenceAdapter.kt` | Specification 기반 필터 구현 |
| `backend/event-service/.../handler/NewsQueryHandler.kt` | `findByFilters()` 사용 |
| `backend/event-service/.../port/out/news/NewsContentGeneratePort.kt` | `stockName` 파라미터 추가 |
| `backend/event-service/.../generator/NewsContentGeneratorWithLLM.kt` | 종목명 프롬프트 + fallback 제거 + retry |
| `backend/event-service/.../handler/news/GameNewsGenerationHandler.kt` | StockQueryPort 주입, 종목 조회 |
| `backend/event-service/.../generator/NpcNameGeneratorWithLLM.kt` | fallback 제거, retry 유지 |
| `backend/event-service/.../generator/InstitutionNameGeneratorWithLLM.kt` | fallback 제거, retry 추가 |
| `backend/event-service/.../generator/CompanyNameGeneratorWithLLM.kt` | fallback 제거 |
| `backend/event-service/.../handler/institution/InstitutionCreationHandler.kt` | fallback 제거 |
| `backend/scheduler-service/.../scheduler/NpcCreationScheduler.kt` | 10분 → 24시간 |
| `backend/scheduler-service/.../scheduler/InstitutionCreationScheduler.kt` | 2시간 → 24시간 |

## 배포 시 필요 작업
```bash
docker exec stockSimulator-postgres psql -U stocksim -d stocksimulator \
  -c "DROP SCHEMA IF EXISTS trading CASCADE; CREATE SCHEMA trading;"
docker-compose --profile all up -d --build event-service trading-service scheduler-service
```
