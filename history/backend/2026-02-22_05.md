# 2026-02-22_05: NPC/기관 포트폴리오 investorType 버그 수정 및 매매 결정 토큰 절약

## 변경 사항

### 1. NPC/기관 거래 시 investorType 누락 버그 수정
- `TradingEventConsumer.handleScheduleTrade()`에서 `PlaceOrderCommand` 생성 시 `investorType`을 전달하지 않아 기본값 `USER`로 저장되던 버그 수정
- 이로 인해 NPC/기관의 포트폴리오, 주문, 체결 내역이 모두 `USER` 타입으로 저장되어 프론트엔드에서 조회 불가

### 2. 매매 결정 LLM 응답에서 reason 필드 제거 (토큰 절약)
- LLM 프롬프트를 간소화하고 `reason` 필드를 제거하여 토큰 소비 대폭 감소
- `TradingDecisionResult`, `LlmTradingResponse`, `ScheduleTradeEvent`에서 reason 필드 삭제
- NpcTradingHandler, InstitutionTradingHandler 로그에서 reason 참조 제거

### 3. 기존 잘못된 데이터 수정용 SQL 마이그레이션 작성
- `trading.orders`, `trading.portfolios`, `trading.trades` 테이블의 investor_type을 ID 접두사 기반으로 수정

## 수정 파일 목록
| 파일 | 변경 |
|------|------|
| `backend/trading-service/.../event/TradingEventConsumer.kt` | `investorType` 전달 추가 |
| `backend/event-service/.../generator/TradingDecisionGeneratorWithLLM.kt` | reason 제거, 프롬프트 간소화 |
| `backend/event-service/.../trading/TradingDecisionGeneratePort.kt` | `TradingDecisionResult`에서 reason 제거 |
| `backend/event-service/.../trading/NpcTradingHandler.kt` | reason 참조 제거 |
| `backend/event-service/.../trading/InstitutionTradingHandler.kt` | reason 참조 제거 |
| `backend/common/.../event/DomainEvent.kt` | `ScheduleTradeEvent`에서 reason 제거 |
| `backend/trading-service/.../migration/V1__fix_npc_institution_investor_type.sql` | 데이터 마이그레이션 SQL |

## 배포 시 필요 작업
- **SQL 마이그레이션 실행 필수**: `V1__fix_npc_institution_investor_type.sql`을 DB에 실행하여 기존 잘못된 investor_type 데이터 수정
- trading-service, event-service 재빌드 및 재배포
