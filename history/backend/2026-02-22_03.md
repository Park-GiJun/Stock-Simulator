# 2026-02-22_03: NPC/기관투자자 잔고 초기화 + event-service Feign DTO 수정

## 변경 사항

### 1. NPC/기관 생성 시 trading-service 잔고 자동 초기화
- stock-service에서 NPC/기관 저장 후 `investor.balance.init` Kafka 이벤트 발행
- trading-service에서 해당 이벤트를 수신하여 `investor_balances` 테이블에 초기 잔고 생성
- investorId 규칙: NPC → `NPC_{npcId}`, 기관 → `INST_{institutionId}`

### 2. event-service Feign DTO 수정
- `BalanceResponse`: `balance` 필드 → `investorId`, `investorType`, `cash` 필드로 변경 (trading-service 실제 응답 구조와 일치)
- `TradingServiceFeignClient.getPortfolio()`: 반환 타입 `ApiResponse<List<PortfolioHoldingResponse>>` → `ApiResponse<PortfolioResponse>` (wrapper 구조)
- `InvestorPortfolioQueryAdapter`: `response.data?.balance` → `response.data?.cash`, `response.data?.map` → `response.data?.holdings?.map`

### 3. 기존 NPC/기관 잔고 일괄 초기화 SQL
- `backend/sql/init_existing_investor_balances.sql` 추가
- 이미 생성된 NPC/기관 중 잔고가 없는 경우 INSERT하는 마이그레이션 쿼리

## 수정 파일 목록

| 파일 | 변경 |
|------|------|
| `common/.../event/DomainEvent.kt` | `INVESTOR_BALANCE_INIT` 토픽 + `InvestorBalanceInitEvent` 추가 |
| `stock-service/.../handler/npc/NpcCommandHandler.kt` | 저장 후 잔고 초기화 이벤트 발행 |
| `stock-service/.../handler/institution/InstitutionCommandHandler.kt` | 저장 후 잔고 초기화 이벤트 발행 |
| `stock-service/.../port/out/InvestorBalanceEventPublishPort.kt` | 잔고 초기화 이벤트 발행 포트 (신규) |
| `stock-service/.../adapter/out/event/KafkaInvestorBalancePublisher.kt` | Kafka 발행 어댑터 (신규) |
| `trading-service/.../adapter/in/event/TradingEventConsumer.kt` | `INVESTOR_BALANCE_INIT` 리스너 추가 |
| `event-service/.../client/dto/TradingClientDtos.kt` | Feign DTO 수정 (`BalanceResponse`, `PortfolioResponse` 추가) |
| `event-service/.../client/TradingServiceFeignClient.kt` | `getPortfolio()` 반환 타입 수정 |
| `event-service/.../client/adapter/InvestorPortfolioQueryAdapter.kt` | 응답 매핑 수정 (`cash`, `holdings`) |
| `backend/sql/init_existing_investor_balances.sql` | 기존 NPC/기관 잔고 일괄 초기화 SQL (신규) |

## 배포 시 필요 작업
1. `backend/sql/init_existing_investor_balances.sql` 실행하여 기존 NPC/기관 잔고 초기화
2. stock-service, trading-service, event-service 재배포
