# Stock Simulator 서버 배포 가이드

## 배포 전제 조건

1. **서버 환경**: Ubuntu/Linux 서버
2. **프로젝트 위치**: `/home/jun/Stock-Simulator`
3. **필수 도구**:
   - Git
   - Docker & Docker Compose
   - JDK 17+
   - Gradle (또는 ./gradlew 사용)

## 배포 방식

### 1. 태그 기반 배포 (권장)

태그를 사용하면 특정 버전으로 확실하게 배포할 수 있습니다.

#### 1.1 전체 배포 스크립트 (상세한 로그)

```bash
# 서버에서 실행
cd /home/jun/Stock-Simulator
chmod +x deploy-with-tag.sh
./deploy-with-tag.sh v1.3.2
```

**포함 기능:**
- Git 태그 체크아웃
- Gradle 클린 빌드
- Docker 이미지 재빌드
- 서비스 상태 확인
- 로그 출력

**예상 시간:** 약 5-10분

#### 1.2 빠른 배포 스크립트 (최소한의 로그)

```bash
# 서버에서 실행
cd /home/jun/Stock-Simulator
chmod +x quick-deploy.sh
./quick-deploy.sh v1.3.2
```

**예상 시간:** 약 3-5분

### 2. 롤백

문제 발생 시 이전 버전으로 롤백:

```bash
cd /home/jun/Stock-Simulator
chmod +x rollback.sh
./rollback.sh v1.3.1  # 이전 버전으로 롤백
```

## 배포 프로세스

### 단계별 설명

1. **태그 생성 및 푸시** (개발 환경)
   ```bash
   git add -A
   git commit -m "설명"
   git tag -a v1.3.2 -m "Release v1.3.2: 설명"
   git push origin master
   git push origin v1.3.2
   ```

2. **서버 배포** (서버 환경)
   ```bash
   cd /home/jun/Stock-Simulator
   ./deploy-with-tag.sh v1.3.2
   ```

3. **배포 확인**
   ```bash
   # 컨테이너 상태 확인
   docker-compose --profile all ps
   
   # Eureka 서버 확인
   curl http://localhost:8761/actuator/health
   
   # 서비스 등록 확인
   curl http://localhost:8761/eureka/apps
   ```

## 수동 배포 (스크립트 미사용)

스크립트를 사용하지 않고 수동으로 배포하는 경우:

```bash
# 1. 프로젝트 디렉토리로 이동
cd /home/jun/Stock-Simulator

# 2. 최신 태그 가져오기
git fetch --tags --force

# 3. 특정 태그로 체크아웃
git checkout v1.3.2

# 4. 빌드
./gradlew clean build -x test --no-daemon

# 5. 기존 컨테이너 중지
docker-compose --profile all down

# 6. Docker 이미지 빌드
docker-compose --profile all build --no-cache

# 7. 컨테이너 시작
docker-compose --profile all up -d

# 8. 로그 확인
docker logs stockSimulator-eureka-server -f
```

## 배포 후 확인 사항

### 1. 컨테이너 상태

```bash
docker-compose --profile all ps
```

모든 서비스가 `Up` 상태여야 합니다.

### 2. Eureka 대시보드

브라우저에서 접속: `http://서버IP:8761`

등록된 서비스 확인:
- API-GATEWAY
- USER-SERVICE
- STOCK-SERVICE
- TRADING-SERVICE
- EVENT-SERVICE
- SCHEDULER-SERVICE
- NEWS-SERVICE

### 3. 서비스 헬스 체크

```bash
# API Gateway
curl http://localhost:9832/actuator/health

# User Service
curl http://localhost:8081/actuator/health

# Stock Service
curl http://localhost:8082/actuator/health
```

### 4. Grafana 모니터링

브라우저에서 접속: `http://서버IP:3001`
- 계정: admin / stocksim123
- Dashboard: "Stock Simulator - Services Overview" 확인

### 5. 로그 확인

```bash
# 모든 서비스 로그
docker-compose --profile all logs -f

# 특정 서비스 로그
docker logs stockSimulator-eureka-server -f
docker logs stockSimulator-api-gateway -f
docker logs stockSimulator-user-service -f
```

## 태그 버전 관리

### 버전 네이밍 규칙

- **Major.Minor.Patch** (예: v1.3.2)
  - **Major (1)**: 큰 기능 변경, 호환성 없는 변경
  - **Minor (3)**: 새로운 기능 추가, 하위 호환
  - **Patch (2)**: 버그 수정, 작은 개선

### 현재 태그 목록

```bash
git tag --list
```

**출력 예시:**
```
v1.0.0
v1.1.0
v1.2.0
v1.2.1
v1.2.2
v1.2.3
v1.2.4
v1.2.5
v1.3.0
v1.3.1
v1.3.2  ← 최신
```

### 태그 상세 정보 확인

```bash
git show v1.3.2
```

## 문제 해결

### 1. Docker 빌드 실패

```bash
# Docker 캐시 삭제 후 재빌드
docker-compose --profile all build --no-cache
```

### 2. Gradle 빌드 실패

```bash
# Gradle 캐시 삭제
./gradlew clean --no-daemon

# 의존성 재다운로드
./gradlew build --refresh-dependencies -x test --no-daemon
```

### 3. 서비스가 Eureka에 등록 안 됨

```bash
# 서비스 재시작
docker-compose --profile all restart <service-name>

# 로그 확인
docker logs stockSimulator-<service-name> --tail 100
```

### 4. Kafka Cluster ID 불일치

```bash
# Kafka 데이터 초기화
docker-compose --profile all down
docker volume rm stock-simulator_kafka_data stock-simulator_zookeeper_data
docker-compose --profile all up -d
```

### 5. 포트 충돌

```bash
# 포트 사용 확인
netstat -tuln | grep 8761
netstat -tuln | grep 9832

# 프로세스 종료
kill -9 $(lsof -t -i:8761)
```

## 배포 체크리스트

배포 전:
- [ ] 로컬에서 모든 테스트 통과
- [ ] Git 커밋 완료
- [ ] 태그 생성 및 푸시
- [ ] 서버 디스크 공간 확인 (`df -h`)
- [ ] 서버 메모리 확인 (`free -h`)

배포 중:
- [ ] 스크립트 실행 권한 확인 (`chmod +x`)
- [ ] 빌드 성공 확인
- [ ] Docker 이미지 빌드 성공
- [ ] 모든 컨테이너 시작 확인

배포 후:
- [ ] Eureka 대시보드에서 모든 서비스 등록 확인
- [ ] API Gateway 응답 확인
- [ ] Grafana 대시보드 확인
- [ ] 로그에서 에러 없는지 확인
- [ ] 기본 API 동작 테스트

## 배포 스크립트 파일

1. **deploy-with-tag.sh**: 전체 배포 (상세 로그)
2. **quick-deploy.sh**: 빠른 배포 (최소 로그)
3. **rollback.sh**: 이전 버전으로 롤백

모든 스크립트는 프로젝트 루트 디렉토리에 위치합니다.

## 자동화 고려 사항 (향후)

1. **GitHub Actions**: 태그 푸시 시 자동 배포
2. **Jenkins**: CI/CD 파이프라인 구축
3. **Ansible**: 멀티 서버 배포 자동화
4. **Blue-Green Deployment**: 무중단 배포

## 참고 자료

- 프로젝트 README: `/README.md`
- 인프라 문서: `/doc/인프라_구축_진행상황.md`
- Docker Compose 설정: `/docker-compose.yml`
- Gradle 설정: `/build.gradle.kts`
