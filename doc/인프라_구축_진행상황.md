# Stock-Simulator ì¸í”„ë¼ êµ¬ì¶• ì§„í–‰ìƒí™©

**ì‘ì„±ì¼:** 2025-01-24
**ì„œë²„:** 172.30.1.79 (homeserver)
**ë„ë©”ì¸:** gijun.net

---

## ğŸ“‹ ëª©ì°¨
1. [ì™„ë£Œëœ ì‘ì—…](#ì™„ë£Œëœ-ì‘ì—…)
2. [í˜„ì¬ ìƒíƒœ](#í˜„ì¬-ìƒíƒœ)
3. [ì§„í–‰ ì¤‘ì¸ ì‘ì—…](#ì§„í–‰-ì¤‘ì¸-ì‘ì—…)
4. [ë‚¨ì€ ì‘ì—…](#ë‚¨ì€-ì‘ì—…)
5. [ëª…ë ¹ì–´ ëª¨ìŒ](#ëª…ë ¹ì–´-ëª¨ìŒ)
6. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê¸°ë¡](#íŠ¸ëŸ¬ë¸”ìŠˆíŒ…-ê¸°ë¡)

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. K3s ì„¤ì¹˜
```bash
curl -sfL https://get.k3s.io | sh -
```
- K3s (ê²½ëŸ‰ Kubernetes) ì„¤ì¹˜ ì™„ë£Œ
- kubectl ì„¤ì • ì™„ë£Œ

### 2. Namespace ìƒì„±
```bash
kubectl apply -f infra/k8s/base/namespaces.yaml
```
ìƒì„±ëœ Namespace:
- `stocksim-apps` - ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤
- `stocksim-db` - ë°ì´í„°ë² ì´ìŠ¤
- `stocksim-infra` - Kafka, Elasticsearch
- `stocksim-monitoring` - Prometheus, Grafana
- `argocd` - ArgoCD

### 3. Secrets ìƒì„±
```bash
kubectl apply -f infra/k8s/base/secrets.yaml
```
- MySQL, MongoDB, Redis ì¸ì¦ ì •ë³´
- Grafana ì¸ì¦ ì •ë³´

### 4. ë°ì´í„°ë² ì´ìŠ¤ ë°°í¬ (ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤)

#### MySQL Master (6ê°œ ì„œë¹„ìŠ¤ë³„)
```bash
kubectl apply -f infra/k8s/databases/mysql/
```
| ì„œë¹„ìŠ¤ | Pod | Database | ìƒíƒœ |
|--------|-----|----------|------|
| user-service | mysql-user-master-0 | userdb | âœ… Running |
| stock-service | mysql-stock-master-0 | stockdb | âœ… Running |
| trading-service | mysql-trading-master-0 | tradingdb | âœ… Running |
| event-service | mysql-event-master-0 | eventdb | âœ… Running |
| scheduler-service | mysql-scheduler-master-0 | schedulerdb | âœ… Running |
| season-service | mysql-season-master-0 | seasondb | âœ… Running |

> âš ï¸ **ì°¸ê³ :** MySQL ReplicaëŠ” PostStartHook ì—ëŸ¬ë¡œ ì¸í•´ ì œê±°ë¨. ì¶”í›„ ìˆ˜ë™ ì„¤ì • í•„ìš”.

#### MongoDB (ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤)
```bash
# ê°„ì†Œí™”ëœ MongoDB ë°°í¬
cat << 'EOF' | kubectl apply -f -
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
  namespace: stocksim-db
spec:
  serviceName: mongodb
  replicas: 1
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      containers:
        - name: mongodb
          image: mongo:7.0
          ports:
            - containerPort: 27017
          env:
            - name: MONGO_INITDB_ROOT_USERNAME
              value: "stocksim"
            - name: MONGO_INITDB_ROOT_PASSWORD
              value: "stocksim123"
          volumeMounts:
            - name: data
              mountPath: /data/db
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: local-path
        resources:
          requests:
            storage: 5Gi
EOF
```
- mongodb-0: âœ… Running

#### Redis Master (ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤)
- redis-master-0: âœ… Running
> âš ï¸ **ì°¸ê³ :** Redis Sentinelì€ DNS í•´ì„ ë¬¸ì œë¡œ ì œê±°ë¨.

### 5. Infrastructure ë°°í¬

#### Kafka (ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤)
```bash
# Confluent Kafka ì´ë¯¸ì§€ ì‚¬ìš©
cat << 'EOF' | kubectl apply -f -
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kafka
  namespace: stocksim-infra
spec:
  serviceName: kafka
  replicas: 1
  selector:
    matchLabels:
      app: kafka
  template:
    metadata:
      labels:
        app: kafka
    spec:
      containers:
        - name: kafka
          image: confluentinc/cp-kafka:7.5.0
          ports:
            - containerPort: 9092
          env:
            - name: KAFKA_NODE_ID
              value: "1"
            - name: KAFKA_PROCESS_ROLES
              value: "broker,controller"
            - name: KAFKA_CONTROLLER_QUORUM_VOTERS
              value: "1@localhost:9093"
            - name: KAFKA_LISTENERS
              value: "PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093"
            - name: KAFKA_ADVERTISED_LISTENERS
              value: "PLAINTEXT://kafka.stocksim-infra.svc.cluster.local:9092"
            - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP
              value: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
            - name: KAFKA_CONTROLLER_LISTENER_NAMES
              value: "CONTROLLER"
            - name: KAFKA_INTER_BROKER_LISTENER_NAME
              value: "PLAINTEXT"
            - name: CLUSTER_ID
              value: "MkU3OEVBNTcwNTJENDM2Qk"
            - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
              value: "1"
            - name: KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR
              value: "1"
            - name: KAFKA_TRANSACTION_STATE_LOG_MIN_ISR
              value: "1"
          volumeMounts:
            - name: data
              mountPath: /var/lib/kafka/data
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: local-path
        resources:
          requests:
            storage: 5Gi
EOF
```
- kafka-0: âœ… Running
- kafka-ui: âœ… Running

#### Elasticsearch & Kibana
```bash
kubectl apply -f infra/k8s/infrastructure/elasticsearch/
```
- elasticsearch-0: âœ… Running
- kibana: âœ… Running

### 6. Backend ë¹Œë“œ ë° Docker ì´ë¯¸ì§€ ìƒì„±

#### Gradle ë¹Œë“œ
```bash
cd ~/Stock-Simulator/backend
chmod +x ./gradlew
./gradlew build -x test
```

#### Docker ì´ë¯¸ì§€ ë¹Œë“œ
```bash
cd ~/Stock-Simulator

# ê° ì„œë¹„ìŠ¤ë³„ ì´ë¯¸ì§€ ë¹Œë“œ
docker build -t stocksim/eureka-server:latest -f - backend/eureka-server << 'EOF'
FROM eclipse-temurin:21-jre-alpine
WORKDIR /app
COPY build/libs/*.jar app.jar
ENV JAVA_OPTS="-Xms256m -Xmx512m"
EXPOSE 8761
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
EOF

# ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ë‚˜ë¨¸ì§€ ì„œë¹„ìŠ¤ë“¤ ë¹Œë“œ
# api-gateway, user-service, stock-service, trading-service
# event-service, news-service, scheduler-service, season-service
```

#### K3sì— ì´ë¯¸ì§€ ë¡œë“œ
```bash
for img in eureka-server api-gateway user-service stock-service trading-service event-service news-service scheduler-service season-service; do
  docker save stocksim/$img:latest | sudo k3s ctr images import -
done
```

### 7. ê¸°ì¡´ ì„œë¹„ìŠ¤ ì¤‘ì§€
```bash
pm2 stop all
pm2 delete all
sudo kill <java_pid>  # ê¸°ì¡´ Spring Boot í”„ë¡œì„¸ìŠ¤
```

---

## ğŸ“Š í˜„ì¬ ìƒíƒœ

### stocksim-db Namespace
```
NAME                       READY   STATUS    
mongodb-0                  1/1     Running   
mysql-event-master-0       1/1     Running   
mysql-scheduler-master-0   1/1     Running   
mysql-season-master-0      1/1     Running   
mysql-stock-master-0       1/1     Running   
mysql-trading-master-0     1/1     Running   
mysql-user-master-0        1/1     Running   
redis-master-0             1/1     Running   
```

### stocksim-infra Namespace
```
NAME                        READY   STATUS    
elasticsearch-0             1/1     Running   
kafka-0                     1/1     Running   
kafka-ui-xxxxx              1/1     Running   
kibana-xxxxx                1/1     Running   
```

### stocksim-apps Namespace
```
NAME                                READY   STATUS             
api-gateway-xxxxx                   1/1     Running            âœ…
eureka-server-xxxxx                 1/1     Running            âœ…
event-service-xxxxx                 0/1     CrashLoopBackOff   âŒ
news-service-xxxxx                  0/1     CrashLoopBackOff   âŒ
scheduler-service-xxxxx             0/1     CrashLoopBackOff   âŒ
season-service-xxxxx                0/1     CrashLoopBackOff   âŒ
stock-service-xxxxx                 0/1     CrashLoopBackOff   âŒ
trading-service-xxxxx               0/1     CrashLoopBackOff   âŒ
user-service-xxxxx                  0/1     CrashLoopBackOff   âŒ
```

---

## ğŸ”„ ì§„í–‰ ì¤‘ì¸ ì‘ì—…

### ë¬¸ì œ: ì„œë¹„ìŠ¤ë“¤ì´ DBì— ì—°ê²°í•˜ì§€ ëª»í•¨

**ì›ì¸:** application.ymlì˜ k8s í”„ë¡œíŒŒì¼ì—ì„œ multi-datasource (write/read) ì„¤ì •ì„ í–ˆì§€ë§Œ, Spring BootëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë‹¨ì¼ datasourceë§Œ ì§€ì›.

**í•´ê²° ë°©ë²•:** ConfigMapì„ ìˆ˜ì •í•˜ì—¬ ë‹¨ì¼ datasource ì‚¬ìš©

```bash
# user-service ConfigMap ìˆ˜ì • ì˜ˆì‹œ
kubectl delete configmap user-service-config -n stocksim-apps

cat << 'EOF' | kubectl apply -f -
apiVersion: v1
kind: ConfigMap
metadata:
  name: user-service-config
  namespace: stocksim-apps
data:
  application-k8s.yml: |
    spring:
      datasource:
        url: jdbc:mysql://mysql-user-master.stocksim-db.svc.cluster.local:3306/userdb?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul
        username: stocksim
        password: stocksim123
        driver-class-name: com.mysql.cj.jdbc.Driver
      jpa:
        hibernate:
          ddl-auto: update
      flyway:
        enabled: false
      kafka:
        bootstrap-servers: kafka.stocksim-infra.svc.cluster.local:9092
      data:
        redis:
          host: redis-master.stocksim-db.svc.cluster.local
          port: 6379
          password: stocksim123
    eureka:
      client:
        service-url:
          defaultZone: http://eureka-server.stocksim-apps.svc.cluster.local:8761/eureka/
      instance:
        prefer-ip-address: true
EOF

# ê° ì„œë¹„ìŠ¤ë³„ë¡œ ë™ì¼í•˜ê²Œ ConfigMap ìˆ˜ì • í›„:
kubectl rollout restart deployment -n stocksim-apps
```

---

## ğŸ“ ë‚¨ì€ ì‘ì—…

### 1. ConfigMap ìˆ˜ì • ë° ì„œë¹„ìŠ¤ ì¬ì‹œì‘
- [ ] user-service ConfigMap ìˆ˜ì •
- [ ] stock-service ConfigMap ìˆ˜ì •
- [ ] trading-service ConfigMap ìˆ˜ì •
- [ ] event-service ConfigMap ìˆ˜ì •
- [ ] scheduler-service ConfigMap ìˆ˜ì •
- [ ] season-service ConfigMap ìˆ˜ì •
- [ ] news-service ConfigMap ìˆ˜ì •
- [ ] Pod ì¬ì‹œì‘: `kubectl rollout restart deployment -n stocksim-apps`

### 2. Nginx ì„¤ì • ì—…ë°ì´íŠ¸
```bash
sudo cp ~/Stock-Simulator/infra/nginx/gijun.net.nodeport /etc/nginx/sites-available/gijun.net
sudo nginx -t
sudo systemctl reload nginx
```

### 3. NodePort ì„œë¹„ìŠ¤ ë°°í¬
```bash
kubectl apply -f infra/k8s/infrastructure/nodeport-services.yaml
```

### 4. Frontend ë¹Œë“œ ë° ë°°í¬ (ì„ íƒì‚¬í•­)
```bash
# Node.js ì„¤ì¹˜ í•„ìš”
cd ~/Stock-Simulator/frontend
pnpm install
pnpm build
# Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° K3sì— ë¡œë“œ
```

### 5. Monitoring ë°°í¬ (ì„ íƒì‚¬í•­)
```bash
kubectl apply -f infra/k8s/monitoring/
```

### 6. ArgoCD ì„¤ì¹˜ (ì„ íƒì‚¬í•­)
```bash
./infra/scripts/setup-argocd.sh
```

---

## ğŸ› ï¸ ëª…ë ¹ì–´ ëª¨ìŒ

### ìƒíƒœ í™•ì¸
```bash
# ì „ì²´ Pod ìƒíƒœ
kubectl get pods --all-namespaces | grep -v kube-system

# ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë³„ í™•ì¸
kubectl get pods -n stocksim-db
kubectl get pods -n stocksim-infra
kubectl get pods -n stocksim-apps

# ì„œë¹„ìŠ¤ í™•ì¸
kubectl get svc -n stocksim-apps

# ë¡œê·¸ í™•ì¸
kubectl logs <pod-name> -n <namespace> --tail=50

# Pod ìƒì„¸ ì •ë³´
kubectl describe pod <pod-name> -n <namespace>
```

### ì¬ì‹œì‘
```bash
# íŠ¹ì • Deployment ì¬ì‹œì‘
kubectl rollout restart deployment <deployment-name> -n stocksim-apps

# ëª¨ë“  Deployment ì¬ì‹œì‘
kubectl rollout restart deployment -n stocksim-apps
```

### ì‚­ì œ
```bash
# Pod ì‚­ì œ (Deploymentê°€ ìë™ìœ¼ë¡œ ì¬ìƒì„±)
kubectl delete pod <pod-name> -n <namespace>

# Deployment ì‚­ì œ
kubectl delete deployment <deployment-name> -n <namespace>
```

### Docker ì´ë¯¸ì§€ ê´€ë¦¬
```bash
# ë¡œì»¬ Docker ì´ë¯¸ì§€ í™•ì¸
docker images | grep stocksim

# K3sì— ì´ë¯¸ì§€ ë¡œë“œ
docker save stocksim/<service>:latest | sudo k3s ctr images import -

# K3s ì´ë¯¸ì§€ í™•ì¸
sudo k3s ctr images list | grep stocksim
```

---

## ğŸ› íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê¸°ë¡

### 1. MySQL Replica PostStartHookError
**ì¦ìƒ:** MySQL Replica Podê°€ `PostStartHookError` ìƒíƒœ
**ì›ì¸:** PostStart lifecycle hookì—ì„œ replication ì„¤ì • ì‹¤íŒ¨
**í•´ê²°:** Replica ì œê±°, Masterë§Œ ì‚¬ìš© (ì¶”í›„ ìˆ˜ë™ ì„¤ì •)

### 2. Redis Sentinel DNS í•´ì„ ì‹¤íŒ¨
**ì¦ìƒ:** `Failed to resolve hostname 'redis-master.stocksim-db.svc.cluster.local'`
**ì›ì¸:** Sentinelì´ ì‹œì‘ë  ë•Œ Master ì„œë¹„ìŠ¤ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ
**í•´ê²°:** Sentinel ì œê±°, Masterë§Œ ì‚¬ìš©

### 3. Kafka í´ëŸ¬ìŠ¤í„° DNS í•´ì„ ì‹¤íŒ¨
**ì¦ìƒ:** `UnknownHostException: kafka-1.kafka.stocksim-infra.svc.cluster.local`
**ì›ì¸:** 3-node Kafka í´ëŸ¬ìŠ¤í„°ì—ì„œ ë…¸ë“œ ê°„ DNS í•´ì„ ì§€ì—°
**í•´ê²°:** ë‹¨ì¼ Kafka ì¸ìŠ¤í„´ìŠ¤ë¡œ ë³€ê²½ (confluentinc/cp-kafka ì´ë¯¸ì§€)

### 4. CPU ë¶€ì¡±ìœ¼ë¡œ Pod Pending
**ì¦ìƒ:** `0/1 nodes are available: 1 Insufficient cpu`
**í•´ê²°:** 
- replica ìˆ˜ ì¤„ì´ê¸°: `sed -i 's/replicas: 2/replicas: 1/g'`
- ë¦¬ì†ŒìŠ¤ ìš”ì²­ëŸ‰ ì¤„ì´ê¸°: `cpu: "100m"`, `memory: "256Mi"`

### 5. ì„œë¹„ìŠ¤ DB ì—°ê²° ì‹¤íŒ¨
**ì¦ìƒ:** `Communications link failure` - MySQL ì—°ê²° ê±°ë¶€
**ì›ì¸:** ConfigMapì˜ multi-datasource ì„¤ì •ì´ Spring Boot ê¸°ë³¸ ì„¤ì •ê³¼ í˜¸í™˜ë˜ì§€ ì•ŠìŒ
**í•´ê²°:** ConfigMapì„ ë‹¨ì¼ datasource ì„¤ì •ìœ¼ë¡œ ìˆ˜ì •

---

## ğŸ“ íŒŒì¼ êµ¬ì¡°

```
infra/
â”œâ”€â”€ k8s/
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”œâ”€â”€ namespaces.yaml      âœ… ì ìš©ë¨
â”‚   â”‚   â””â”€â”€ secrets.yaml         âœ… ì ìš©ë¨
â”‚   â”œâ”€â”€ databases/
â”‚   â”‚   â”œâ”€â”€ mysql/               âœ… ì ìš©ë¨ (Masterë§Œ)
â”‚   â”‚   â”œâ”€â”€ mongodb/             âœ… ì ìš©ë¨ (ê°„ì†Œí™”)
â”‚   â”‚   â””â”€â”€ redis/               âœ… ì ìš©ë¨ (Masterë§Œ)
â”‚   â”œâ”€â”€ infrastructure/
â”‚   â”‚   â”œâ”€â”€ kafka/               âœ… ì ìš©ë¨ (ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤)
â”‚   â”‚   â”œâ”€â”€ elasticsearch/       âœ… ì ìš©ë¨
â”‚   â”‚   â”œâ”€â”€ ingress/             â³ ëŒ€ê¸°
â”‚   â”‚   â””â”€â”€ nodeport-services.yaml â³ ëŒ€ê¸°
â”‚   â”œâ”€â”€ apps/                    ğŸ”„ ìˆ˜ì • í•„ìš” (ConfigMap)
â”‚   â”œâ”€â”€ monitoring/              â³ ëŒ€ê¸°
â”‚   â””â”€â”€ argocd/                  â³ ëŒ€ê¸°
â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ gijun.net.nodeport       â³ ì ìš© ëŒ€ê¸°
â”‚   â””â”€â”€ README.md
â””â”€â”€ scripts/
    â”œâ”€â”€ setup-cluster.sh
    â”œâ”€â”€ setup-argocd.sh
    â””â”€â”€ build-images.sh
```

---

## ğŸ”— ì ‘ì† URL (ì„¤ì • ì™„ë£Œ í›„)

| ì„œë¹„ìŠ¤ | URL |
|--------|-----|
| Frontend | https://gijun.net/ |
| API | https://gijun.net/api/ |
| Swagger | https://gijun.net/swagger-ui |
| Eureka | https://gijun.net/eureka |
| Grafana | https://gijun.net/grafana/ |
| ArgoCD | https://gijun.net/argocd |

---

**ë‹¤ìŒ ë‹¨ê³„:** ConfigMap ìˆ˜ì • í›„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
