# Stock-Simulator ì¸í”„ë¼ êµ¬ì¶• ì§„í–‰ìƒí™©

**ìµœì¢… ìˆ˜ì •ì¼:** 2025-01-24
**ì„œë²„:** 172.30.1.79 (homeserver)
**ë„ë©”ì¸:** gijun.net / api.gijun.net

---

## ğŸ“‹ ëª©ì°¨
1. [ì™„ë£Œëœ ì‘ì—…](#ì™„ë£Œëœ-ì‘ì—…)
2. [í˜„ì¬ ìƒíƒœ](#í˜„ì¬-ìƒíƒœ)
3. [í™˜ê²½ ì„¤ì •](#í™˜ê²½-ì„¤ì •)
4. [ëª…ë ¹ì–´ ëª¨ìŒ](#ëª…ë ¹ì–´-ëª¨ìŒ)
5. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê¸°ë¡](#íŠ¸ëŸ¬ë¸”ìŠˆíŒ…-ê¸°ë¡)

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. Docker Compose ì¸í”„ë¼ êµ¬ì¶• âœ…

ëª¨ë“  ì¸í”„ë¼ ì„œë¹„ìŠ¤ê°€ Docker Composeë¡œ êµ¬ì„±ë˜ì–´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.

### 2. ë°ì´í„°ë² ì´ìŠ¤ ë°°í¬ âœ…

| ì„œë¹„ìŠ¤ | ì»¨í…Œì´ë„ˆ | í¬íŠ¸ | ìƒíƒœ |
|--------|---------|------|------|
| PostgreSQL Primary | stockSimulator-postgres | 5432 | âœ… Healthy |
| PostgreSQL Replica | stockSimulator-postgres-replica | 5433 | âœ… Running |
| MongoDB | stockSimulator-mongo | 27018 | âœ… Healthy |
| Redis | stockSimulator-redis | 6380 | âœ… Healthy |

### 3. ë©”ì‹œì§€ ë¸Œë¡œì»¤ & ê²€ìƒ‰ì—”ì§„ âœ…

| ì„œë¹„ìŠ¤ | ì»¨í…Œì´ë„ˆ | í¬íŠ¸ | ìƒíƒœ |
|--------|---------|------|------|
| Zookeeper | stockSimulator-zookeeper | 2181 | âœ… Healthy |
| Kafka | stockSimulator-kafka | 9093 | âœ… Healthy |
| Kafka UI | stockSimulator-kafka-ui | 8089 | âœ… Running |
| Elasticsearch | stockSimulator-elasticsearch | 9201 | âœ… Healthy |

### 4. ëª¨ë‹ˆí„°ë§ âœ…

| ì„œë¹„ìŠ¤ | ì»¨í…Œì´ë„ˆ | í¬íŠ¸ | ìƒíƒœ |
|--------|---------|------|------|
| Prometheus | stockSimulator-prometheus | 9091 | âœ… Running |
| Grafana | stockSimulator-grafana | 3001 | âœ… Running |

**Grafana ëŒ€ì‹œë³´ë“œ:**
- "Stock Simulator - Services Overview" ëŒ€ì‹œë³´ë“œ êµ¬ì„± ì™„ë£Œ
- ì„œë¹„ìŠ¤ ìƒíƒœ, ìš”ì²­ë¥ , ì‘ë‹µì‹œê°„, JVM ë©”ëª¨ë¦¬, CPU ì‚¬ìš©ë¥  ëª¨ë‹ˆí„°ë§

### 5. ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ë°°í¬ âœ…

| ì„œë¹„ìŠ¤ | ì»¨í…Œì´ë„ˆ | í¬íŠ¸ | Prometheus | ìƒíƒœ |
|--------|---------|------|------------|------|
| Eureka Server | stockSimulator-eureka-server | 8761 | âœ… UP | âœ… Healthy |
| API Gateway | stockSimulator-api-gateway | 9832 | âœ… UP | âœ… Healthy |
| User Service | stockSimulator-user-service | 8081 | âœ… UP | âœ… Running |
| Stock Service | stockSimulator-stock-service | 8082 | âœ… UP | âœ… Running |
| Trading Service | stockSimulator-trading-service | 8083 | âš ï¸ DOWN | ğŸ”„ Starting |
| Event Service | stockSimulator-event-service | 8084 | âš ï¸ DOWN | ğŸ”„ Starting |
| Scheduler Service | stockSimulator-scheduler-service | 8085 | âš ï¸ DOWN | ğŸ”„ Starting |
| News Service | stockSimulator-news-service | 8086 | âš ï¸ DOWN | ğŸ”„ Starting |
| Season Service | stockSimulator-season-service | 8087 | âœ… UP | âœ… Running |

### 6. ì„¤ì • íŒŒì¼ êµ¬ì¡° âœ…

ê° ì„œë¹„ìŠ¤ì— í™˜ê²½ë³„ ì„¤ì • íŒŒì¼ ì¶”ê°€:

```
backend/{service}/src/main/resources/
â”œâ”€â”€ application.yml          # ë¡œì»¬ ê°œë°œ í™˜ê²½ (localhost)
â””â”€â”€ application-docker.yml   # Docker í™˜ê²½ (í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©)
```

---

## ğŸ“Š í˜„ì¬ ìƒíƒœ

### ì „ì²´ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
```bash
docker-compose --profile all ps
```

### Prometheus íƒ€ê²Ÿ ìƒíƒœ í™•ì¸
```bash
curl -s http://localhost:9091/api/v1/targets | jq '.data.activeTargets[] | {job: .labels.job, health: .health}'
```

---

## âš™ï¸ í™˜ê²½ ì„¤ì •

### .env íŒŒì¼ (ì„œë²„ì— ì§ì ‘ ë°°í¬)

```env
# =============================================================================
# Stock Simulator - Environment Variables
# =============================================================================

# -----------------------------------------------------------------------------
# Infrastructure Hosts
# -----------------------------------------------------------------------------
INFRA_HOST=172.30.1.79
EUREKA_HOST=172.30.1.79
POSTGRES_HOST=172.30.1.79
REDIS_HOST=172.30.1.79
MONGO_HOST=172.30.1.79
KAFKA_HOST=172.30.1.79
ELASTICSEARCH_HOST=172.30.1.79

# -----------------------------------------------------------------------------
# PostgreSQL
# -----------------------------------------------------------------------------
POSTGRES_USER=stocksim
POSTGRES_PASSWORD=stocksim123
POSTGRES_DB=stocksimulator
POSTGRES_PORT=5432

# -----------------------------------------------------------------------------
# MongoDB
# -----------------------------------------------------------------------------
MONGO_USER=stocksim
MONGO_PASSWORD=stocksim123
MONGO_PORT=27017

# -----------------------------------------------------------------------------
# Redis
# -----------------------------------------------------------------------------
REDIS_PASSWORD=stocksim123
REDIS_PORT=6379

# -----------------------------------------------------------------------------
# Kafka
# -----------------------------------------------------------------------------
KAFKA_PORT=9092

# -----------------------------------------------------------------------------
# Elasticsearch
# -----------------------------------------------------------------------------
ELASTICSEARCH_PORT=9200

# -----------------------------------------------------------------------------
# Eureka
# -----------------------------------------------------------------------------
EUREKA_PORT=8761

# -----------------------------------------------------------------------------
# Grafana
# -----------------------------------------------------------------------------
GRAFANA_ADMIN_USER=admin
GRAFANA_ADMIN_PASSWORD=stocksim123

# -----------------------------------------------------------------------------
# Application URLs
# -----------------------------------------------------------------------------
API_URL=https://api.gijun.net
FRONTEND_URL=https://gijun.net

# -----------------------------------------------------------------------------
# Spring Profiles
# -----------------------------------------------------------------------------
SPRING_PROFILES_ACTIVE=docker
```

---

## ğŸ› ï¸ ëª…ë ¹ì–´ ëª¨ìŒ

### Docker Compose ê´€ë¦¬

```bash
# ì „ì²´ ì„œë¹„ìŠ¤ ì‹œì‘
docker-compose --profile all up -d

# ì¬ë¹Œë“œ í›„ ì‹œì‘
docker-compose --profile all up -d --build

# íŠ¹ì • ì„œë¹„ìŠ¤ë§Œ ì¬ë¹Œë“œ
docker-compose --profile all up -d --build eureka-server

# ì „ì²´ ì„œë¹„ìŠ¤ ì¤‘ì§€
docker-compose --profile all down

# ë³¼ë¥¨ í¬í•¨ ì‚­ì œ (ë°ì´í„° ì‚­ì œë¨!)
docker-compose --profile all down -v

# ì„œë¹„ìŠ¤ ì¬ì‹œì‘
docker-compose --profile all restart <service-name>

# ë¡œê·¸ í™•ì¸
docker logs stockSimulator-<service-name> 2>&1 | tail -50

# ìƒíƒœ í™•ì¸
docker-compose --profile all ps
```

### Gradle ë¹Œë“œ

```bash
# ì „ì²´ ë¹Œë“œ
./gradlew clean build -x test

# íŠ¹ì • ì„œë¹„ìŠ¤ ë¹Œë“œ
./gradlew :backend:eureka-server:clean :backend:eureka-server:build
./gradlew :backend:user-service:clean :backend:user-service:build
./gradlew :backend:api-gateway:clean :backend:api-gateway:build
```

### ì»¨í…Œì´ë„ˆ ì ‘ì†

```bash
# PostgreSQL
docker exec -it stockSimulator-postgres psql -U stocksim -d stocksimulator

# MongoDB
docker exec -it stockSimulator-mongo mongosh -u stocksim -p stocksim123 --authenticationDatabase admin

# Redis
docker exec -it stockSimulator-redis redis-cli -a stocksim123

# Kafka í† í”½ í™•ì¸
docker exec -it stockSimulator-kafka kafka-topics --list --bootstrap-server localhost:9092
```

### ëª¨ë‹ˆí„°ë§

```bash
# Prometheus íƒ€ê²Ÿ ìƒíƒœ
curl -s http://localhost:9091/api/v1/targets | jq '.data.activeTargets[] | {job: .labels.job, health: .health}'

# íŠ¹ì • ì„œë¹„ìŠ¤ health check
curl http://localhost:8081/actuator/health  # user-service
curl http://localhost:8761/actuator/health  # eureka-server
```

---

## ğŸ› íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê¸°ë¡

### 1. Kafka Cluster ID ë¶ˆì¼ì¹˜ (2025-01-24)

**ì—ëŸ¬:**
```
kafka.common.InconsistentClusterIdException: The Cluster ID xxx doesn't match stored clusterId Some(yyy) in meta.properties
```

**ì›ì¸:** Kafka ë³¼ë¥¨ì— ì €ì¥ëœ í´ëŸ¬ìŠ¤í„° IDì™€ Zookeeperì˜ í´ëŸ¬ìŠ¤í„° IDê°€ ë‹¤ë¦„

**í•´ê²°:**
```bash
docker-compose --profile all down
docker volume rm stock-simulator_kafka_data stock-simulator_zookeeper_data
docker-compose --profile all up -d
```

### 2. Eureka Serverê°€ í¬íŠ¸ 8080ì—ì„œ ì‹œì‘ (2025-01-24)

**ì—ëŸ¬:** Eureka Server healthcheck ì‹¤íŒ¨ (8761 ì²´í¬í•˜ëŠ”ë° 8080ì—ì„œ ì‹¤í–‰ë¨)

**ì›ì¸:** `application.yml`ì´ jarì— í¬í•¨ë˜ì§€ ì•Šì•˜ê³ , `application-docker.yml`ë„ ì—†ì—ˆìŒ

**í•´ê²°:**
1. `backend/eureka-server/src/main/resources/application.yml` ìƒì„±
2. `backend/eureka-server/src/main/resources/application-docker.yml` ìƒì„±
3. ì¬ë¹Œë“œ: `./gradlew :backend:eureka-server:clean :backend:eureka-server:build`
4. Docker ì¬ì‹œì‘: `docker-compose --profile all up -d --build eureka-server`

### 3. ì„œë¹„ìŠ¤ë“¤ì´ Eurekaì— localhost:8761ë¡œ ì—°ê²° ì‹œë„ (2025-01-24)

**ì—ëŸ¬:**
```
Connection refused: localhost:8761
```

**ì›ì¸:** Docker í™˜ê²½ì—ì„œ `localhost`ê°€ ì•„ë‹Œ ì„œë¹„ìŠ¤ ì´ë¦„ìœ¼ë¡œ ì—°ê²°í•´ì•¼ í•¨

**í•´ê²°:**
1. ëª¨ë“  ì„œë¹„ìŠ¤ì— `application-docker.yml` ìƒì„±
2. í™˜ê²½ë³€ìˆ˜ë¡œ í˜¸ìŠ¤íŠ¸ ì„¤ì •: `${EUREKA_HOST:eureka-server}:${EUREKA_PORT:8761}`
3. `.env` íŒŒì¼ì—ì„œ í˜¸ìŠ¤íŠ¸ IP ë˜ëŠ” ì„œë¹„ìŠ¤ëª… ì„¤ì •

### 4. Grafanaì—ì„œ Prometheus ì—°ê²° ì‹¤íŒ¨ (2025-01-24)

**ì—ëŸ¬:** Prometheus datasource ì—°ê²° ì‹¤íŒ¨

**ì›ì¸:** `infra/grafana/provisioning/datasources/datasources.yml`ì—ì„œ ì»¨í…Œì´ë„ˆ ì´ë¦„ ëŒ€ì‹  ì„œë¹„ìŠ¤ ì´ë¦„ ì‚¬ìš©í•´ì•¼ í•¨

**í•´ê²°:**
```yaml
# Before (ì˜ëª»ë¨)
url: http://stockSimulator-prometheus:9090

# After (ì˜¬ë°”ë¦„)
url: http://prometheus:9090
```

---

## ğŸ”— ì ‘ì† URL

| ì„œë¹„ìŠ¤ | URL |
|--------|-----|
| Frontend | https://gijun.net/ |
| API Gateway | https://api.gijun.net/ |
| Eureka Dashboard | http://172.30.1.79:8761/ |
| Kafka UI | http://172.30.1.79:8089/ |
| Grafana | http://172.30.1.79:3001/ (admin/stocksim123) |
| Prometheus | http://172.30.1.79:9091/ |
| Prometheus Targets | http://172.30.1.79:9091/targets |

---

## ğŸ“ ì„¤ì • íŒŒì¼ êµ¬ì¡°

```
Stock-Simulator/
â”œâ”€â”€ .env                              # í™˜ê²½ë³€ìˆ˜ (ì„œë²„ì— ì§ì ‘ ë°°í¬, Git ì œì™¸)
â”œâ”€â”€ .env.example                      # í™˜ê²½ë³€ìˆ˜ ì˜ˆì‹œ
â”œâ”€â”€ docker-compose.yml                # Docker Compose ì„¤ì •
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ eureka-server/
â”‚   â”‚   â””â”€â”€ src/main/resources/
â”‚   â”‚       â”œâ”€â”€ application.yml       # ë¡œì»¬ ê°œë°œ
â”‚   â”‚       â””â”€â”€ application-docker.yml # Docker í™˜ê²½
â”‚   â”œâ”€â”€ api-gateway/
â”‚   â”‚   â””â”€â”€ src/main/resources/
â”‚   â”‚       â”œâ”€â”€ application.yml
â”‚   â”‚       â””â”€â”€ application-docker.yml
â”‚   â”œâ”€â”€ user-service/
â”‚   â”‚   â””â”€â”€ src/main/resources/
â”‚   â”‚       â”œâ”€â”€ application.yml
â”‚   â”‚       â””â”€â”€ application-docker.yml
â”‚   â””â”€â”€ ... (ê° ì„œë¹„ìŠ¤ ë™ì¼ êµ¬ì¡°)
â””â”€â”€ infra/
    â”œâ”€â”€ grafana/
    â”‚   â””â”€â”€ provisioning/
    â”‚       â”œâ”€â”€ dashboards/
    â”‚       â”‚   â”œâ”€â”€ dashboards.yml
    â”‚       â”‚   â””â”€â”€ stock-simulator-overview.json
    â”‚       â””â”€â”€ datasources/
    â”‚           â””â”€â”€ datasources.yml
    â””â”€â”€ prometheus/
        â””â”€â”€ prometheus.yml
```

---

## ğŸ“ ë‹¤ìŒ ì‘ì—…

1. [ ] DOWN ìƒíƒœì¸ ì„œë¹„ìŠ¤ ë¡œê·¸ í™•ì¸ ë° ìˆ˜ì • (trading, event, scheduler, news)
2. [ ] Grafana ëŒ€ì‹œë³´ë“œ í…Œì´ë¸” í˜•íƒœë¡œ ê°œì„ 
3. [ ] Frontend ë°°í¬ ë° ì—°ë™ í…ŒìŠ¤íŠ¸
4. [ ] Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ SSL ì„¤ì •
5. [ ] ì„œë¹„ìŠ¤ë³„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ êµ¬í˜„
