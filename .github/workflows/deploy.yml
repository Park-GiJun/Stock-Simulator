name: Deploy to Server

on:
  # cd-build-push.ymlì—ì„œ íŠ¸ë¦¬ê±°
  repository_dispatch:
    types: [deploy]
  
  # ìˆ˜ë™ ë°°í¬
  workflow_dispatch:
    inputs:
      services:
        description: 'ë°°í¬í•  ì„œë¹„ìŠ¤ (ì‰¼í‘œë¡œ êµ¬ë¶„, all=ì „ì²´)'
        required: true
        default: 'all'
        type: string

env:
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  DEPLOY_PATH: ~/Stock-Simulator

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            
            echo "ðŸ“¥ Pulling latest changes..."
            git pull origin main
            
            echo "ðŸ”§ Checking .env file..."
            if [ ! -f .env ]; then
              echo "âŒ .env file not found! Creating from .env.example..."
              cp .env.example .env
              echo "âš ï¸ Please update .env with actual values!"
            fi
            
            echo "ðŸ”¨ Rebuilding and restarting services..."
            
            # ì„œë¹„ìŠ¤ë³„ ìž¬ë¹Œë“œ ë° ìž¬ì‹œìž‘
            docker-compose --profile services up -d --build
            docker-compose --profile frontend up -d --build
            
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Deployment complete!"
            docker-compose ps
          ENDSSH

      - name: Health Check
        run: |
          sleep 30
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'ENDSSH'
            echo "ðŸ¥ Health check..."
            
            # API Gateway ì²´í¬
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:9832/actuator/health | grep -q "200"; then
              echo "âœ… API Gateway: OK"
            else
              echo "âŒ API Gateway: FAILED"
              exit 1
            fi
            
            # Frontend ì²´í¬
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 | grep -q "200"; then
              echo "âœ… Frontend: OK"
            else
              echo "âŒ Frontend: FAILED"
              exit 1
            fi
            
            echo "ðŸŽ‰ All services healthy!"
          ENDSSH

      - name: Notify on failure
        if: failure()
        run: echo "âŒ Deployment failed! Check the logs."
