name: Deploy to Development

on:
  push:
    branches:
      - develop
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/stocksim
  ENVIRONMENT: dev

jobs:
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        service:
          - eureka-server
          - api-gateway
          - user-service
          - stock-service
          - trading-service
          - event-service
          - scheduler-service
          - news-service
          - season-service
          - frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21 (Backend only)
        if: matrix.service != 'frontend'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Build Backend JAR
        if: matrix.service != 'frontend'
        working-directory: backend
        run: |
          chmod +x gradlew
          ./gradlew :${{ matrix.service }}:bootJar -x test

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=raw,value=dev-latest
            type=sha,prefix=dev-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service == 'frontend' && 'frontend' || format('backend/{0}', matrix.service) }}
          file: ${{ matrix.service == 'frontend' && 'frontend/Dockerfile' || format('backend/{0}/Dockerfile', matrix.service) }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            ${{ matrix.service == 'frontend' && format('VITE_API_URL={0}', vars.DEV_API_URL || 'http://localhost:9832') || '' }}

  deploy:
    name: Deploy to Dev Server
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: development
      url: ${{ vars.DEV_URL || 'http://dev.stocksimulator.com' }}

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh ${{ secrets.DEV_SERVER_USER || secrets.SERVER_USER }}@${{ secrets.DEV_SERVER_HOST }} << 'ENDSSH'
            cd ~/Stock-Simulator-dev || exit 1
            
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin
            git checkout develop
            git pull origin develop
            
            echo "ðŸ” Logging into GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
            
            echo "ðŸ³ Pulling latest images..."
            docker-compose --profile all pull
            
            echo "ðŸ”„ Restarting services..."
            docker-compose --profile all up -d
            
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Deployment complete!"
          ENDSSH

      - name: Wait for services
        run: sleep 30

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Run health checks
        run: |
          ssh ${{ secrets.DEV_SERVER_USER || secrets.SERVER_USER }}@${{ secrets.DEV_SERVER_HOST }} << 'ENDSSH'
            echo "ðŸ¥ Running health checks..."
            
            # API Gateway
            if curl -s -f http://localhost:9832/actuator/health | grep -q "UP"; then
              echo "âœ… API Gateway: UP"
            else
              echo "âŒ API Gateway: DOWN"
              exit 1
            fi
            
            # Eureka Server
            if curl -s -f http://localhost:8761/actuator/health | grep -q "UP"; then
              echo "âœ… Eureka Server: UP"
            else
              echo "âŒ Eureka Server: DOWN"
              exit 1
            fi
            
            # Frontend
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 | grep -q "200"; then
              echo "âœ… Frontend: UP"
            else
              echo "âŒ Frontend: DOWN"
              exit 1
            fi
            
            echo "âœ… All health checks passed!"
            
            # Container status
            echo ""
            echo "ðŸ“Š Service Status:"
            docker-compose --profile all ps
          ENDSSH

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Development Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Development |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | develop |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **All services are healthy**" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: always()

    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.health-check.result }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "${{ steps.status.outputs.emoji }} Development Deployment ${{ steps.status.outputs.status }}",
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "fields": [
                    {
                      "title": "Environment",
                      "value": "Development",
                      "short": true
                    },
                    {
                      "title": "Status",
                      "value": "${{ steps.status.outputs.status }}",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "develop",
                      "short": true
                    },
                    {
                      "title": "Deployed by",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "Commit",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>",
                      "short": false
                    }
                  ],
                  "actions": [
                    {
                      "type": "button",
                      "text": "View Deployment",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
