name: Deploy to Staging

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/stocksim
  ENVIRONMENT: staging

jobs:
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        service:
          - eureka-server
          - api-gateway
          - user-service
          - stock-service
          - trading-service
          - event-service
          - scheduler-service
          - news-service
          - season-service
          - frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21 (Backend only)
        if: matrix.service != 'frontend'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Build Backend JAR
        if: matrix.service != 'frontend'
        working-directory: backend
        run: |
          chmod +x gradlew
          ./gradlew :${{ matrix.service }}:bootJar -x test

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=raw,value=staging-latest
            type=raw,value=latest
            type=sha,prefix=staging-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service == 'frontend' && 'frontend' || format('backend/{0}', matrix.service) }}
          file: ${{ matrix.service == 'frontend' && 'frontend/Dockerfile' || format('backend/{0}/Dockerfile', matrix.service) }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            ${{ matrix.service == 'frontend' && format('VITE_API_URL={0}', vars.STAGING_API_URL || 'http://localhost:9832') || '' }}

  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests..."
          # TODO: API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ ì¶”ê°€
          echo "âœ… Smoke tests passed"

  deploy:
    name: Deploy to Staging Server
    runs-on: ubuntu-latest
    needs: [build-and-push, smoke-test]
    environment:
      name: staging
      url: ${{ vars.STAGING_URL || 'http://staging.stocksimulator.com' }}

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.STAGING_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          ssh ${{ secrets.STAGING_SERVER_USER || secrets.SERVER_USER }}@${{ secrets.STAGING_SERVER_HOST }} << 'ENDSSH'
            cd ~/Stock-Simulator-staging || exit 1
            
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin
            git checkout main
            git pull origin main
            
            echo "ðŸ” Logging into GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
            
            echo "ðŸ³ Pulling latest images..."
            docker-compose --profile all pull
            
            echo "ðŸ”„ Restarting services with zero-downtime strategy..."
            # ì„œë¹„ìŠ¤ë³„ ìˆœì°¨ ìž¬ì‹œìž‘ (API GatewayëŠ” ë§ˆì§€ë§‰ì—)
            for service in eureka-server user-service stock-service trading-service event-service scheduler-service news-service season-service frontend api-gateway; do
              echo "Restarting $service..."
              docker-compose --profile all up -d --no-deps $service
              sleep 5
            done
            
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Deployment complete!"
          ENDSSH

      - name: Wait for services
        run: sleep 45

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run integration tests
        run: |
          echo "ðŸ§ª Running integration tests against staging..."
          # TODO: ì‹¤ì œ integration test ì¶”ê°€
          
          STAGING_URL="${{ vars.STAGING_URL || 'http://staging.stocksimulator.com' }}"
          
          # Health check
          if curl -s -f "${STAGING_URL}/actuator/health" | grep -q "UP"; then
            echo "âœ… API health check passed"
          else
            echo "âŒ API health check failed"
            exit 1
          fi
          
          echo "âœ… Integration tests passed"

  health-check:
    name: Comprehensive Health Check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.STAGING_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Run health checks
        run: |
          ssh ${{ secrets.STAGING_SERVER_USER || secrets.SERVER_USER }}@${{ secrets.STAGING_SERVER_HOST }} << 'ENDSSH'
            echo "ðŸ¥ Running comprehensive health checks..."
            
            FAILED=0
            
            # API Gateway
            if curl -s -f http://localhost:9832/actuator/health | grep -q "UP"; then
              echo "âœ… API Gateway: UP"
            else
              echo "âŒ API Gateway: DOWN"
              FAILED=1
            fi
            
            # Eureka Server
            if curl -s -f http://localhost:8761/actuator/health | grep -q "UP"; then
              echo "âœ… Eureka Server: UP"
            else
              echo "âŒ Eureka Server: DOWN"
              FAILED=1
            fi
            
            # All backend services
            for service in user-service stock-service trading-service event-service scheduler-service news-service season-service; do
              # Eurekaì— ë“±ë¡ëœ ì„œë¹„ìŠ¤ í™•ì¸
              if curl -s http://localhost:8761/eureka/apps | grep -q "$service"; then
                echo "âœ… $service: Registered in Eureka"
              else
                echo "âš ï¸ $service: Not found in Eureka"
              fi
            done
            
            # Frontend
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 | grep -q "200"; then
              echo "âœ… Frontend: UP"
            else
              echo "âŒ Frontend: DOWN"
              FAILED=1
            fi
            
            # Infrastructure health
            echo ""
            echo "ðŸ—„ï¸ Infrastructure Health:"
            
            # PostgreSQL
            if docker exec stockSimulator-postgres pg_isready -U stocksim > /dev/null 2>&1; then
              echo "âœ… PostgreSQL: UP"
            else
              echo "âŒ PostgreSQL: DOWN"
              FAILED=1
            fi
            
            # Redis
            if docker exec stockSimulator-redis redis-cli ping | grep -q "PONG"; then
              echo "âœ… Redis: UP"
            else
              echo "âŒ Redis: DOWN"
              FAILED=1
            fi
            
            # MongoDB
            if docker exec stockSimulator-mongo mongosh --quiet --eval "db.runCommand({ ping: 1 })" | grep -q "ok"; then
              echo "âœ… MongoDB: UP"
            else
              echo "âŒ MongoDB: DOWN"
              FAILED=1
            fi
            
            if [ $FAILED -eq 1 ]; then
              echo "::error::Health check failed"
              exit 1
            fi
            
            echo ""
            echo "âœ… All health checks passed!"
            
            # Container status
            echo ""
            echo "ðŸ“Š Service Status:"
            docker-compose --profile all ps
          ENDSSH

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Staging |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | main |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed by | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **All services and infrastructure are healthy**" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy, integration-test, health-check]
    if: always()

    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.health-check.result }}" = "success" ] && [ "${{ needs.integration-test.result }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "${{ steps.status.outputs.emoji }} Staging Deployment ${{ steps.status.outputs.status }}",
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.color }}",
                  "fields": [
                    {
                      "title": "Environment",
                      "value": "Staging",
                      "short": true
                    },
                    {
                      "title": "Status",
                      "value": "${{ steps.status.outputs.status }}",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "main",
                      "short": true
                    },
                    {
                      "title": "Deployed by",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "Commit",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>",
                      "short": false
                    }
                  ],
                  "actions": [
                    {
                      "type": "button",
                      "text": "View Deployment",
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": "View Staging",
                      "url": "${{ vars.STAGING_URL || 'http://staging.stocksimulator.com' }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
